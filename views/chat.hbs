<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat â€” Comment Corner</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" type="text/css" href="/styles/main.css">
    <style>
        /* Consistent styling with the rest of the site */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f7fafc; color:#1a202c; margin:0; padding-top: 10px; padding-left: 5px; padding-right: 5px; }
        .wrap { max-width:900px; margin:0 auto; background:#fff; padding:2rem; border-radius:8px; box-shadow:0 8px 24px rgba(11,22,33,0.06); margin-top: 25px; }
        header h1 { margin:0 0 0.25rem 0; font-size:1.6rem; }
        header p.lead { margin:0 0 1rem 0; color:#4a5568; }
        
        /* Chat specific styles */
        .chat-container { background:#f1f5f9; border-left:4px solid #2b6cb0; padding:1.5rem; border-radius:6px; margin:1rem 0; height: 400px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; background: #fff; border-radius: 4px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
        .message { background: #f0f0f0; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 4px; display: flex; align-items: flex-start; gap: 0.75rem; }
        .message-content { flex: 1; }
        .message-meta { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .message-author { font-weight: 600; color: #1a202c; }
        .message-time { color: #718096; font-size: 0.85rem; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #2b6cb0; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
        .message-input { display: flex; gap: 0.5rem; }
        .message-input input { flex: 1; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 1rem; }
        .message-input input:focus { outline: none; border-color: #2b6cb0; box-shadow: 0 0 0 3px rgba(43,108,176,0.1); }
        .btn { display: inline-block; text-decoration: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; }
        .btn-primary { background: #2b6cb0; color: #fff; }
        .btn-primary:hover { background: #2c5aa0; }
        .chat-placeholder { color: #718096; font-style: italic; text-align: center; padding: 2rem; }
        .info { margin-top: 1.25rem; color: #4a5568; line-height: 1.5; }
    </style>
</head>
<body>
    {{> nav}}

    <main class="wrap">
        <header>
            <h1>Chat</h1>
            <p class="lead">Connect with other members of the Comment Corner community in real-time.</p>
        </header>

        <section class="chat-container" aria-labelledby="chat-window">
            <h2 id="chat-window" style="margin:0 0 1rem 0; font-size:1.1rem;">Community Chat</h2>
            
            <div class="chat-messages" id="chatMessages">
                <div class="chat-placeholder">
                    Welcome to the chat! Start a conversation below.
                </div>
            </div>

            <div class="message-input">
                <input id="messageInput" type="text" placeholder="Type your message here..." maxlength="50" />
                <button type="button" class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
        </section>
    </main>

    {{> footer}}

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <script>
        // On initial load, fetch chat history
        fetch('/api/chat/history')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = ''; // Clear existing messages / placeholder
                    data.messages.forEach(message => {
                        const messageDiv = buildMessage(message);
                        chatMessages.appendChild(messageDiv);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });

        const socket = io("https://sswd.lax18.dev");

        socket.on("message", (data) => {
            const chatMessages = document.getElementById('chatMessages');
            
            // Remove placeholder if it exists
            const placeholder = document.querySelector('.chat-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const messageDiv = buildMessage(data);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                socket.emit('new_message', message);
                input.value = '';
            }
        }

        function buildMessage(data) {
            // Convert TZ
            console.log(data.createdAt);
            data.createdAt = new Date(data.createdAt).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });

            const message = `
                <div class="message">
                    <div class="avatar" style="background-color: ${data.avatarColor};">${data.avatarInitial}</div>
                    <div class="message-content">
                        <div class="message-meta">
                            <span class="message-author">${data.display_name}</span>
                            <span class="message-time">${data.createdAt}</span>
                        </div>
                        <div class="message-text">${data.content}</div>
                    </div>
                </div>
            `

            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = message;

            // Kinda gross way to handle this, but I like these format templates
            return messageDiv;
        }
        
        // Allow Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>